# [Kafka](http://kafka.apache.org/)

<!-- TOC -->

- [Kafka](#kafka)
    - [æ¦‚è¿°](#æ¦‚è¿°)
        - [ä»€ä¹ˆæ˜¯Kafka](#ä»€ä¹ˆæ˜¯kafka)
        - [ç‰¹ç‚¹](#ç‰¹ç‚¹)
        - [Kafkaæ¶æ„](#kafkaæ¶æ„)
    - [Kafkaå·¥ä½œæµç¨‹](#kafkaå·¥ä½œæµç¨‹)
        - [Kafkaç”Ÿäº§è€…](#kafkaç”Ÿäº§è€…)
            - [åˆ†åŒºåŸå› ](#åˆ†åŒºåŸå› )
            - [åˆ†åŒºç­–ç•¥](#åˆ†åŒºç­–ç•¥)
    - [Kafkaæ¶ˆè´¹è€…](#kafkaæ¶ˆè´¹è€…)
    - [Kafkaé›†ç¾¤éƒ¨ç½²](#kafkaé›†ç¾¤éƒ¨ç½²)
    - [Kafka API](#kafka-api)
        - [Producer API](#producer-api)
            - [æ¶ˆæ¯å‘é€æµç¨‹](#æ¶ˆæ¯å‘é€æµç¨‹)
            - [å¼‚æ­¥å‘é€API](#å¼‚æ­¥å‘é€api)
            - [åŒæ­¥å‘é€API](#åŒæ­¥å‘é€api)
        - [Customer API](#customer-api)
            - [è‡ªåŠ¨æäº¤offset](#è‡ªåŠ¨æäº¤offset)
            - [æ‰‹åŠ¨æäº¤offset](#æ‰‹åŠ¨æäº¤offset)
            - [è‡ªå®šä¹‰å­˜å‚¨offset](#è‡ªå®šä¹‰å­˜å‚¨offset)
        - [è‡ªå®šä¹‰Intercepter](#è‡ªå®šä¹‰intercepter)
    - [Kafkaå¯¹æ¥Flume](#kafkaå¯¹æ¥flume)

<!-- /TOC -->
---
## æ¦‚è¿°

### ä»€ä¹ˆæ˜¯Kafka

åˆ†å¸ƒå¼çš„åŸºäºå‘å¸ƒ/è®¢é˜…æ¨¡å¼çš„**æ¶ˆæ¯é˜Ÿåˆ—**ï¼Œåº”ç”¨äºå¤§æ•°æ®**å®æ—¶**å¤„ç†é¢†åŸŸï¼Œå¤šç”¨äºæ•°æ®çš„å®æ—¶ä¼ è¾“ã€‚

> æ¶ˆæ¯é˜Ÿåˆ—ï¼šæ˜¯ä¸€ç§è¿›ç¨‹é—´é€šä¿¡æˆ–åŒä¸€è¿›ç¨‹çš„ä¸åŒçº¿ç¨‹é—´çš„é€šä¿¡æ–¹å¼
>
> åº”ç”¨åœºæ™¯ï¼šä¸¤ç³»ç»Ÿé—´é€šä¿¡ï¼Œä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ç­‰ï¼ˆåº”ç”¨è€¦åˆã€å¼‚æ­¥å¤„ç†ã€æµé‡å‰Šé”‹ï¼‰
>
> ä¸¤ç§æ¨¡å¼ï¼š
>
> â€‹	ç‚¹å¯¹ç‚¹ï¼ˆä¸€å¯¹ä¸€ï¼‰ï¼šæ¶ˆè´¹è€…ä¸»åŠ¨æ‹‰å»æ•°æ®ï¼Œæ¶ˆæ¯æ¶ˆè´¹å®Œåˆ é™¤
>
> â€‹	å‘å¸ƒ/è®¢é˜…ï¼ˆä¸€å¯¹å¤šï¼‰ï¼šå®¢æˆ·ç«¯ä¸»åŠ¨æ¨é€æ•°æ®ï¼Œæ¶ˆæ¯ä¼šæŒä¹…åŒ–ä¿å­˜åˆ°æœ¬åœ°ï¼Œä¿å­˜ä¸€æ®µæ—¶é—´

### ç‰¹ç‚¹

- åŒæ—¶ä¸ºå‘å¸ƒå’Œè®¢é˜…æä¾›é«˜ååé‡ã€‚
- å¯è¿›è¡ŒæŒä¹…åŒ–æ“ä½œã€‚å°†æ¶ˆæ¯æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œå› æ­¤å¯ç”¨äºæ‰¹é‡æ¶ˆè´¹ï¼Œä¾‹å¦‚ETLï¼Œä»¥åŠå®æ—¶åº”ç”¨ç¨‹åºã€‚é€šè¿‡å°†æ•°æ®æŒä¹…åŒ–åˆ°ç¡¬ç›˜ä»¥åŠreplicationé˜²æ­¢æ•°æ®ä¸¢å¤±ã€‚
- åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæ˜“äºå‘å¤–æ‰©å±•ã€‚æ‰€æœ‰çš„producerã€brokerå’Œconsumeréƒ½ä¼šæœ‰å¤šä¸ªï¼Œå‡ä¸ºåˆ†å¸ƒå¼çš„ã€‚æ— éœ€åœæœºå³å¯æ‰©å±•æœºå™¨ã€‚
- æ¶ˆæ¯è¢«å¤„ç†çš„çŠ¶æ€æ˜¯åœ¨consumerç«¯ç»´æŠ¤ï¼Œè€Œä¸æ˜¯ç”±serverç«¯ç»´æŠ¤ã€‚å½“å¤±è´¥æ—¶èƒ½è‡ªåŠ¨å¹³è¡¡ã€‚
- æ”¯æŒonlineå’Œofflineçš„åœºæ™¯ã€‚

### Kafkaæ¶æ„

- åŸºç¡€æ¶æ„

  ![åŸºç¡€æ¶æ„](assets/%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84.png)


  ![å¤šä¸ªPartition](assets/%E5%A4%9A%E4%B8%AApartition.png)

  > â€‹	**ä¸ºäº†æé«˜å¯ç”¨æ€§ï¼Œä¸ºæ¯ä¸ªpartitionå¢åŠ è‹¥å¹²ä¸ªå‰¯æœ¬**ï¼Œç±»ä¼¼NameNode HA

  ![é«˜å¯ç”¨](assets/%E9%AB%98%E5%8F%AF%E7%94%A8.png)

  

- ç®€ä»‹

  Producerï¼šæ¶ˆæ¯ç”Ÿäº§è€…ï¼Œå‘Kafka brokerå‘é€æ¶ˆæ¯çš„å®¢æˆ·ç«¯

  Consumerï¼šæ¶ˆæ¯æ¶ˆè´¹è€…ï¼Œå‘Kafka Broker æ‹‰å–æ¶ˆæ¯

  Consumer Groupï¼šæ¶ˆè´¹è€…ç»„ï¼Œ**ä¸€ä¸ªpartitionåªèƒ½è¢«ä¸€ä¸ªç»„ä¸­çš„ä¸€ä¸ªcustomeræ¶ˆè´¹**ï¼›é€»è¾‘ä¸Šçš„ä¸€ä¸ªè®¢é˜…è€…

  Brokerï¼šä¸€å°KafkaæœåŠ¡å™¨å°±æ˜¯ä¸€ä¸ªBrokerï¼Œå¯å®¹çº³å¤šä¸ªTopic

  Topicï¼šä¸€ä¸ªé˜Ÿåˆ—ï¼Œç±»ä¼¼äºFlumeä¸­çš„Channelï¼›æ¶ˆæ¯ä¿å­˜æ—¶æ ¹æ®topicè¿›è¡Œåˆ†ç±»

  Partitionï¼šå¯ä»¥è§£ä¸ºä¸€ä¸ªå¤§çš„Topicï¼›ä¸€ä¸ªTopicå¯ä»¥åˆ†ä¸ºå¤šä¸ªpartitionï¼Œæ¯ä¸ªpartitionæ˜¯ä¸€ä¸ªæœ‰åºé˜Ÿåˆ—

  Replicaï¼šå‰¯æœ¬ï¼Œä¸ºäº†åœ¨æŸä¸ªèŠ‚ç‚¹æ•…éšœæ—¶æ•°æ®ä¸ä¸¢å¤±ï¼Œç»§ç»­ç»´æŒKafkaå·¥ä½œ

  Leaderï¼šæ¯ä¸ªåˆ†åŒºå¤šä¸ªå‰¯æœ¬ä¸­çš„ä¸»

  Followerï¼šæ¯ä¸ªåˆ†åŒºå¤šä¸ªå‰¯æœ¬ä¸­çš„ä»ï¼Œå®æ—¶ä»leaderä¸­åŒæ­¥æ•°æ®ï¼Œä¿æŒå’Œleaderæ•°æ®çš„åŒæ­¥ã€‚leaderå‘ç”Ÿæ•…éšœæ—¶ï¼ŒæŸä¸ªfollowerä¼šæˆä¸ºæ–°çš„follower


## Kafkaå·¥ä½œæµç¨‹

![Kafkaå·¥ä½œæµç¨‹](assets/Kafka%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.png)

```
1. Kafkaä¸­æ¶ˆæ¯æ˜¯ä»¥topicè¿›è¡Œåˆ†ç±»ï¼Œç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯ï¼Œéƒ½æ˜¯é¢å‘topicã€‚
2. topicæ˜¯é€»è¾‘ä¸Šçš„æ¦‚å¿µï¼Œè€Œpartitionæ˜¯ç‰©ç†ä¸Šçš„æ¦‚å¿µï¼Œæ¯ä¸ªpartitionå¯¹åº”äºä¸€ä¸ªlogæ–‡ä»¶ï¼Œ
    è¯¥logæ–‡ä»¶ä¸­å­˜å‚¨çš„å°±æ˜¯producerç”Ÿäº§çš„æ•°æ®ã€‚Producerç”Ÿäº§çš„æ•°æ®ä¼šè¢«è¿½åŠ åˆ°è¯¥logæ–‡ä»¶æœ«ç«¯ï¼Œ
    ä¸”æ¯æ¡æ•°æ®éƒ½æœ‰è‡ªå·±çš„offset(ç±»ä¼¼äºä¹¦ç­¾ğŸ”–)ã€‚æ¶ˆè´¹è€…ç»„ä¸­çš„æ¯ä¸ªæ¶ˆè´¹è€…ï¼Œéƒ½ä¼šå®æ—¶è®°å½•è‡ªå·±
    æ¶ˆè´¹åˆ°äº†å“ªä¸ªoffset(é»˜è®¤50ä¸ªåˆ†åŒº)ï¼Œä»¥ä¾¿å‡ºé”™æ¢å¤æ—¶ï¼Œä»ä¸Šæ¬¡çš„ä½ç½®ç»§ç»­æ¶ˆè´¹ã€‚

```

------

### Kafkaç”Ÿäº§è€…

#### åˆ†åŒºåŸå› 

- æ–¹ä¾¿åœ¨é›†ç¾¤ä¸­æ‹“å±•
- å¯ä»¥æé«˜å¹¶å‘

#### åˆ†åŒºç­–ç•¥
> å°†Producerå‘é€çš„æ•°æ®å°è£…æˆä¸€ä¸ªProducerRecordå¯¹è±¡
- ç›´æ¥æŒ‡æ˜partitionçš„å€¼
- æ²¡æŒ‡æ˜partitionå€¼ï¼Œæœ‰keyï¼›å°†keyçš„hashå€¼ä¸topicçš„partitionæ•°å€¼å–ä½™
- æ²¡æœ‰partitionçš„å€¼ï¼Œæ²¡æœ‰ keyçš„å€¼ï¼›ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶éšæœºç”Ÿæˆä¸€ä¸ªæ•´æ•°ï¼ˆåé¢æ¯æ¬¡è°ƒç”¨åœ¨è¿™ä¸ªæ•´æ•°ä¸Šè‡ªå¢ï¼‰ï¼Œå°†è¿™ä¸ªå€¼ä¸ topic å¯ç”¨çš„ partition æ€»æ•°å–ä½™å¾—åˆ° partition å€¼ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„ `round-robin` ç®—æ³•ã€‚
## Kafkaæ¶ˆè´¹è€…

## Kafkaé›†ç¾¤éƒ¨ç½²

**[ğŸ‘‰å¿«é€Ÿéƒ¨ç½²](<http://kafka.apache.org/quickstart>)**

[ä¸‹è½½Kafka](https://kafka.apache.org/downloads)-kafka_2.11-0.11.0.0.tgz

> â€‹	2.11æ—¶Scalaçš„ç‰ˆæœ¬å·ï¼Œ0.11.0.0æ—¶Kafkaç‰ˆæœ¬å·

è§£å‹åˆ°æŒ‡å®šç›®å½•ï¼Œåˆ›å»º`log`æ–‡ä»¶å¤¹ç”¨äºè¿è¡Œæ—¥å¿—å­˜æ”¾ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶`server.properties`

```
#broker çš„å…¨å±€å”¯ä¸€ç¼–å·ï¼Œä¸èƒ½é‡å¤
broker.id=0
#å¯åˆ é™¤ topic
delete.topic.enable=true
#å¤„ç†ç½‘ç»œè¯·æ±‚çš„çº¿ç¨‹æ•°é‡
num.network.threads=3
#ç”¨æ¥å¤„ç†ç£ç›˜ IO çš„çº¿ç¨‹æ•°
num.io.threads=8
#å‘é€socketçš„ç¼“å†²åŒºå¤§å°
socket.send.buffer.bytes=102400
#æ¥æ”¶socketçš„ç¼“å†²åŒºå¤§å°
socket.receive.buffer.bytes=102400
#è¯·æ±‚socketçš„ç¼“å†²åŒºå¤§å°
socket.request.max.bytes=104857600
#kafka è¿è¡Œæ—¥å¿—å­˜æ”¾çš„è·¯å¾„
log.dirs=/opt/module/kafka/logs
#topic åœ¨å½“å‰ broker ä¸Šçš„åˆ†åŒºä¸ªæ•°
num.partitions=1
#ç”¨æ¥æ¢å¤å’Œæ¸…ç† data ä¸‹æ•°æ®çš„çº¿ç¨‹æ•°é‡
num.recovery.threads.per.data.dir=1
#segment æ–‡ä»¶ä¿ç•™çš„æœ€é•¿æ—¶é—´ï¼Œè¶…æ—¶å°†è¢«åˆ é™¤ï¼ˆå•ä½ï¼šå°æ—¶ï¼‰
log.retention.hours=168
#é…ç½®è¿æ¥ Zookeeper é›†ç¾¤åœ°å€
zookeeper.connect=hadoop102:2181,hadoop103:2181,hadoop104:2181
```

åˆ†å‘å®‰è£…å®Œçš„ç›®å½•åˆ°é›†ç¾¤åŠå…¶ï¼Œå¹¶ä¿®æ”¹`server.properties`ä¸­çš„`broker.id` (ä¸èƒ½é‡å¤)

## Kafka API

> â€‹	å¯¼å…¥ä¾èµ–ï¼š
>
> ````xml
> <dependency>
> 	<groupId>org.apache.kafka</groupId>
> 	<artifactId>kafka-clients</artifactId>
> 	<version>0.11.0.0</version>
> </dependency>
> ````

### Producer API

#### æ¶ˆæ¯å‘é€æµç¨‹

1. å¼‚æ­¥å‘é€ï¼Œæ¶‰åŠä¸‰ä¸ªçº¿ç¨‹â€”â€”mainçº¿ç¨‹å’Œsendçº¿ç¨‹å’ŒRecordAccumulator

2. mainçº¿ç¨‹å°†æ¶ˆæ¯å‘ç»™RecordAccumulatorï¼ŒSenderä»RecordAccumulatorä¸æ–­æ‹‰å–æ•°æ®å‘é€åˆ°Kafkaçš„Broker

   ![æ¶ˆæ¯å‘é€æµç¨‹](assets/%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E6%B5%81%E7%A8%8B.png)

#### å¼‚æ­¥å‘é€API

#### åŒæ­¥å‘é€API

### Customer API

#### è‡ªåŠ¨æäº¤offset

#### æ‰‹åŠ¨æäº¤offset

#### è‡ªå®šä¹‰å­˜å‚¨offset

### è‡ªå®šä¹‰Intercepter

## Kafkaå¯¹æ¥Flume



